<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
  </head>

  <body>
    <div id="CheckOut">
      <input
        type="text"
        id="CheckOut_"
        placeholder="Enter book ID or RFID value"
      />
      <button id="CheckoutFindBook">
        <i class="fa-solid fa-magnifying-glass"></i>
      </button>
      <div style="display: flex; flex-direction: row">
        <table>
          <thead>
            <tr>
              <th>Select</th>
              <th>Book RFID</th>
              <th>Name</th>
              <th>Subject</th>
              <th>Librarian</th>
              <th>Student</th>
              <th>Duration</th>
              <th>Approval</th>
            </tr>
          </thead>
          <tbody id="CheckoutBookList"></tbody>
        </table>

        <div id="BookInfoDisplayCheckOut">
          <h2>Book Information</h2>
          <div id="CheckOutBodyContent"></div>

          <!-- <p><strong>Title:</strong> Another Book Title</p>
            <p><strong>Author(s):</strong> Another Author Name</p>
            <p><strong>ISBN:</strong> 0987654321</p>
            <p><strong>Publication Year:</strong> 2021</p>
            <p><strong>Availability:</strong> Available</p> -->
          <label for="CheckOutStudentID" style="font-weight: bold"
            >Student ID:</label
          >
          <input type="text" id="CheckOutStudentID" name="title" /><br /><br />
          <!-- <label for="duration" style="font-weight: bold"
            >Borrow Duration:</label
          > -->
          <!-- <select id="duration" style="height: 20px; width: 150px" name="title">
            <option value="" disabled selected hidden>Duration</option>
            <option value="oneDay">1 day</option>
            <option value="oneWeek">1 week</option>
            <option value="thirtyDays">30 days</option>
          </select> -->
          <!-- <input type="text" id="duration" name="title" /><br /><br /> -->
          <button onclick="CheckoutEditBook()" id="CheckOutButton">
            Check Out
          </button>
        </div>
      </div>
    </div>
  </body>
  <script src="https://www.gstatic.com/firebasejs/8.3.2/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.3.2/firebase-database.js"></script>
  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCzSMSm6ZHGoLGA7AToiIMHByDFz9yIIbk",
      authDomain: "ashesilibraryesp32-fd5b8.firebaseapp.com",
      databaseURL:
        "https://ashesilibraryesp32-fd5b8-default-rtdb.firebaseio.com",
      projectId: "ashesilibraryesp32-fd5b8",
      storageBucket: "ashesilibraryesp32-fd5b8.appspot.com",
      messagingSenderId: "185836313770",
      appId: "1:185836313770:web:ff9137a24273f2ed0844d3",
      measurementId: "G-J8PWV52BJE",
    };

    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();

    let CheckoutSelectedBookKeys = [];

    function CheckoutDisplayBooks() {
      const CheckoutBookListTable = document.getElementById("CheckoutBookList");
      CheckoutBookListTable.innerHTML = "";

      database
        .ref("LibraryRecords")
        .once("value")
        .then((snapshot) => {
          snapshot.forEach((book) => {
            const bookData = book.val();
            const row = document.createElement("tr");

            // Use unique IDs for each checkbox
            const checkboxId = `CheckBox_${book.key}`;
            row.innerHTML = `
          <td><input type="checkbox" id="${checkboxId}" onchange="CheckoutUpdateSelectedBooks('${book.key}')"/></td>
          <td>${book.key}</td>
          <td>${bookData.name}</td>
          <td>${bookData.subject}</td>
          <td>${bookData.assignedLibrarian}</td>
          <td>${bookData.assignedStudent}</td>
          <td>${bookData.assignedDuration}</td>
          <td>${bookData.approval}</td>

        `;
            CheckoutBookListTable.appendChild(row);
          });
        });
    }

    // Update the array of selected book keys
    function CheckoutUpdateSelectedBooks(bookKey) {
      const checkbox = document.getElementById(`CheckBox_${bookKey}`);
      if (checkbox.checked) {
        // Add the book key to the array
        CheckoutSelectedBookKeys.push(bookKey);
        CheckoutDisplayCard();
      } else {
        // Remove the book key from the array
        CheckoutSelectedBookKeys = CheckoutSelectedBookKeys.filter(
          (key) => key !== bookKey
        );
        CheckoutDisplayCard();
      }
    }

    function CheckoutEditBook() {
      console.log(CheckoutSelectedBookKeys);
      for (let i = 0; i < CheckoutSelectedBookKeys.length; i++) {
        const bookRFID = CheckoutSelectedBookKeys[i];
        const assignedStudent =
          document.getElementById("CheckOutStudentID").value;
        const assignedDuration = "N/A";

        const newApproval = "false";
        const assignedLibrarian = "TestLibrarian";

        if (assignedStudent && assignedDuration) {
          database.ref(`LibraryRecords/${bookRFID}`).update({
            assignedStudent: assignedStudent,
            assignedDuration: assignedDuration,
            assignedLibrarian: assignedLibrarian,
            approval: newApproval.toLowerCase() === "true",
          });

          // Assuming CheckoutDisplayBooks is a function to update the UI, you may call it here
        } else {
          alert("Please enter a valid student ID and duration");
        }
      }
      CheckoutDisplayBooks();
      CheckoutDisplayCard();
    }
    function CheckoutDisplayCard() {
      const cardValue = document.getElementById("CheckOutBodyContent");
      cardValue.innerHTML = "";

      // Display information only for the selected books
      CheckoutSelectedBookKeys.forEach((bookKey) => {
        database
          .ref(`LibraryRecords/${bookKey}`)
          .once("value")
          .then((snapshot) => {
            const bookData = snapshot.val();
            const row = document.createElement("div");
            row.innerHTML = `
          <p id="bookRFID"><strong>bookRFID:</strong> ${bookKey}</p>
          <p id="bookName"><strong>bookName:</strong> ${bookData.name}</p>
          <p id="bookSubject"><strong>bookSubject:</strong> ${bookData.subject}</p>
          <p id="approval"><strong>approval:</strong> ${bookData.approval}</p>
        `;
            cardValue.appendChild(row);
          });
      });
    }

    function CheckoutDisplayBooks() {
      const CheckoutBookListTable = document.getElementById("CheckoutBookList");
      const filterInput = document
        .getElementById("CheckOut_")
        .value.toLowerCase(); // Get the filter input value

      CheckoutBookListTable.innerHTML = "";

      database
        .ref("LibraryRecords")
        .once("value")
        .then((snapshot) => {
          snapshot.forEach((book) => {
            const bookData = book.val();
            const row = document.createElement("tr");

            const bookName = bookData.name.toLowerCase(); // Convert book name to lowercase for case-insensitive search
            const bookRFID = book.key.toLowerCase(); // Convert book RFID to lowercase for case-insensitive search

            // Check if the filterInput is empty or matches the book name or RFID
            if (
              (filterInput === "" ||
                bookName.includes(filterInput) ||
                bookRFID.includes(filterInput)) &&
              bookData.approval
            ) {
              const checkboxId = `CheckBox_${book.key}`;
              row.innerHTML = `
            <td><input type="checkbox" id="${checkboxId}" onchange="CheckoutUpdateSelectedBooks('${book.key}')"/></td>
            <td>${book.key}</td>
            <td>${bookData.name}</td>
            <td>${bookData.subject}</td>
            <td>${bookData.assignedLibrarian}</td>
            <td>${bookData.assignedStudent}</td>
            <td>${bookData.assignedDuration}</td>
            <td>${bookData.approval}</td>
          `;
              CheckoutBookListTable.appendChild(row);
            }
          });
        });
    }

    // Add an event listener for the CheckoutFindBook button to trigger the CheckoutDisplayBooks function
    document
      .getElementById("CheckoutFindBook")
      .addEventListener("click", CheckoutDisplayBooks);

    CheckoutDisplayBooks();
    CheckoutDisplayCard();
  </script>
</html>
